<html>
<head>
<title>Carrier OnTime Performance for Top 10 Airports</title>
</head>

<body>
<div>
<h2 id="ChartTitle">Airline OnTime Performance at US Top10 Airports</h2>

</div>
<!-- <select id="airport" onchange="window.location.href='AirportCarrierStats.html?airport=' + this.value + '&timeframe=' + document.getElementById('timeframe').value" name="airport">
 -->  
<label>Airport: </label>
<!-- <select id="airport" onChange="window.location.href=buildUrl()" name="airport"> -->
<select id="airport" name="airport">
  <option id="ATL" value="ATL">Atlanta International</option>
  <option id="ORD" value="ORD">Chicago O'Hare</option>
  <option id="DFW" value="DFW">Dallas / Fort Worth</option>
  <option id="DEN" value="DEN">Denver International</option>
  <option id="IAH" value="IAH">Houston Intercontinental</option>
  <option id="LAS" value="LAS">Las Vegas McCarran</option>
  <option id="LAX" value="LAX">Los Angeles International</option>
  <option id="MSP" value="MSP">Minneapolis St Paul</option>
  <option id="PHX" value="PHX">Phoenix Sky Harbor</option>
  <option id="SFO" value="SFO">San Francisco International</option>
</select><br>
<label>Timeframe: </label>
<!-- <select id="timeframe" onchange="window.location.href=buildUrl()" name="timeframe"> -->
<select id="timeframe" name="timeframe">
  <option id="annual" value="annual">Annual</option>
  <option id="jan" value="jan">January</option>
  <option id="feb" value="feb">February</option>
  <option id="mar" value="mar">March</option>
  <option id="apr" value="apr">April</option>
  <option id="may" value="may">May</option>
  <option id="jun" value="jun">June</option>
  <option id="jul" value="jul">July</option>
  <option id="aug" value="aug">August</option>
  <option id="sep" value="sep">September</option>
  <option id="oct" value="oct">October</option>
  <option id="nov" value="nov">November</option>
  <option id="dec" value="dec">December</option>
</select>

<button onclick='updateChart()'>Click Me</button>
<div id="chartContainer">
  <script src="lib/d3.v3.4.12.min.js"></script>
  <script src="lib/dimple.v2.1.6.min.js"></script>
  <script type="text/javascript">

    var AIRLINE_DATA = null;

    function buildUrl() {
      return `AirportCarrierStats.html?airport=${document.getElementById('airport').value}&timeframe=${document.getElementById('timeframe').value}`
    }

    function formatPercent(aPercentage) {
      return (Math.round(aPercentage.toFixed(2) * 100)).toString() + "%"
    }

    // Copied from here: http://stackoverflow.com/questions/2901102/how-to-print-a-number-with-commas-as-thousands-separators-in-javascript
    function formatLargeNumber(aNumber) {
      // return Number(aNumber).toLocaleString();
      return aNumber.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,")
    }

    function filterData(selectedAirport, selectedTimeframe) {

    }


    // Update the chart using Javascript
    // Update the chart data and rebuild tooltips
    function updateChart() {
      var selectedAirport = document.getElementById('airport').value;
      var selectedTimeframe = document.getElementById('timeframe').value;
      console.log("Updating chart with new parameters:");
      console.log("Selected Airport: " + selectedAirport);
      console.log("Selected Timeframe: " + selectedTimeframe);

      chartData = AIRLINE_DATA.filter(function(row) {
        return row['Origin'] === selectedAirport;
      });

      // debugger;
      myChart.data = chartData;
      myChart.series[0].getTooltipText = function(e) {
        return buildTooltip(e, chartData);
      };
      myChart.draw(1000);

    }

    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split('=');
            if (decodeURIComponent(pair[0]) == variable) {
                return decodeURIComponent(pair[1]);
            }
        }
        console.log('Query variable %s not found', variable);
    }

    function buildTooltip(e, chartDataSet) {
      console.log("In buildTooltip method...");
      console.log("Value of e is: "  + e);
      var key = e.key;
      var fields = key.split("_");
      var recordType = fields[0];
      var carrier = fields[1];
      var returnValue = "";

      if (recordType === "OnTime") {
        returnValue = [`On-Time Flights = ${formatLargeNumber(e.yValue)}`];
      } else {
          var filtered = data2.filter(function(row) {
            return row['RecordType'] === 'Delayed' && row['CarrierName'] === carrier;
          })
          var ontimeFilter = data2.filter(function(row) {
            return row['RecordType'] === 'OnTime' && row['CarrierName'] === carrier;
          })
          var ontimeFlights = ontimeFilter.reduce(function(a, b) {
            return a + parseFloat(b['Count']);
          }, 0);
          var delayedFlights = e.yValue;
          console.log(`Delayed flights = ${delayedFlights}`)
          console.log(`On-Time flights = ${ontimeFlights}`)
          var totalFlights = ontimeFlights + delayedFlights;
          var delayedPercent = delayedFlights / totalFlights; 
          // debugger;
          var delayedMins = filtered.reduce(function(a, b) {
            return a + parseFloat(b['ArrDelayMins']);
          }, 0);
          var carrierDelayMins = filtered.reduce(function(a, b) {
            return a + parseFloat(b['CarrierDelayMins']);
          }, 0);
          console.log("Delayed mins = " + delayedMins)
          console.log("Carrier Delay mins = " + carrierDelayMins)
          var weatherDelayMins = filtered.reduce(function(a, b) {
            return a + parseFloat(b['WeatherDelayMins']);
          }, 0);
          var nasDelayMins = filtered.reduce(function(a, b) {
            return a + parseFloat(b['NasDelayMins']);
          }, 0);
          var securityDelayMins = filtered.reduce(function(a, b) {
            return a + parseFloat(b['SecurityDelayMins']);
          }, 0);
          var lateAircraftDelayMins = filtered.reduce(function(a, b) {
            return a + parseFloat(b['LateAircraftDelayMins']);
          }, 0);
          // debugger;
          returnValue = [`Delayed Flights = ${formatLargeNumber(e.yValue)} (${formatPercent(delayedPercent)})`,
            `Carrier Delay = ${formatPercent(carrierDelayMins / delayedMins)}`,
            `Weather Delay = ${formatPercent(weatherDelayMins / delayedMins)}`,
            `NAS Delay = ${formatPercent(nasDelayMins / delayedMins)}`,
            `Security Delay = ${formatPercent(securityDelayMins / delayedMins)}`,
            `Late Aircraft Delay = ${formatPercent(lateAircraftDelayMins / delayedMins)}`
            ];
      }
      console.log("KEY = " + key);
      console.log("ReturnValue is: " + returnValue);
      console.log("Leaving buildTooltip method...")
      return returnValue;
    }

    var selectedAirport = getQueryVariable('airport');
    var selectedTimeframe = getQueryVariable('timeframe');
//    debugger;

    // Set defaults if no airport or timeframe is selected
    // (i.e. first time the page is open)
    if (!selectedAirport) {selectedAirport = 'ATL';}
    if (!selectedTimeframe) {selectedTimeframe = 'annual';}

    console.log("Selected airport is: " + selectedAirport);

    document.getElementById(selectedAirport).selected=true;
    document.getElementById(selectedTimeframe).selected=true;


    var svg = dimple.newSvg("#chartContainer", 590, 400);
    var filename = `data/airport_carrier_stats_${selectedTimeframe}.csv`

    var myChart = new dimple.chart(svg, null);
    myChart.setBounds(60, 45, 510, 315);
    myChart.addCategoryAxis("x", "CarrierName");
    myChart.addMeasureAxis("y", "Count");
    var series = myChart.addSeries(["RecordType"], dimple.plot.bar);
    myChart.addLegend(200, 10, 380, 20, "right");

    d3.csv(filename, function (data) {

      AIRLINE_DATA = data;

      updateChart();

    });
  </script>
</div>
<div>
<p>
<p>Carrier On-Time Performance for America's Top 10 Airports

Based on domestic departures
US Department of Transportation - Bureau of Transportation Statistics</p>


Some observations:<br>
<UL>
  <LI>
  Flight delays are not consistent across carriers (even at the same airport in the same month). Some carriers are 'worse' than others.<br>
  </LI>
  <LI>
  Cold weather not always a lead factor in flight delays. United Airlines performance at Chicago in June was abysmal. 41% of the flights were delayed versus 29% in cold Chicago January!
  </LI>
  <LI>
  As much as people complain about time spent in airport security, security is rarely a factor in flight delays.
  </LI>

</p>
</div>
</body>

</html>