<html>
<head>
<title>Carrier OnTime Performance for Top 10 Airports</title>
</head>

<body>
<div>
<h2>Carrier On-Time Performance for America's Top 10</h2>

</div>
<!-- <select id="airport" onchange="window.location.href='AirportCarrierStats.html?airport=' + this.value + '&timeframe=' + document.getElementById('timeframe').value" name="airport">
 -->  
<label>Airport: </label>
<select id="airport" onChange="window.location.href=buildUrl()" name="airport">
  <option id="ATL" value="ATL">Atlanta International</option>
  <option id="ORD" value="ORD">Chicago O'Hare</option>
  <option id="DFW" value="DFW">Dallas / Fort Worth</option>
  <option id="DEN" value="DEN">Denver International</option>
  <option id="IAH" value="IAH">Houston Intercontinental</option>
  <option id="LAS" value="LAS">Las Vegas McCarran</option>
  <option id="LAX" value="LAX">Los Angeles International</option>
  <option id="MSP" value="MSP">Minneapolis St Paul</option>
  <option id="PHX" value="PHX">Phoenix Sky Harbor</option>
  <option id="SFO" value="SFO">San Francisco International</option>
</select><br>
<label>Timeframe: </label>
<select id="timeframe" onchange="window.location.href=buildUrl()" name="timeframe">
  <option id="annual" value="annual">Annual</option>
  <option id="jan" value="jan">January</option>
  <option id="feb" value="feb">February</option>
  <option id="mar" value="mar">March</option>
  <option id="apr" value="apr">April</option>
  <option id="may" value="may">May</option>
  <option id="jun" value="jun">June</option>
  <option id="jul" value="jul">July</option>
  <option id="aug" value="aug">August</option>
  <option id="sep" value="sep">September</option>
  <option id="oct" value="oct">October</option>
  <option id="nov" value="nov">November</option>
  <option id="dec" value="dec">December</option>
</select>
<div id="chartContainer">
  <script src="lib/d3.v3.4.12.min.js"></script>
  <script src="lib/dimple.v2.1.6.min.js"></script>
  <script type="text/javascript">

  function buildUrl() {
    return `AirportCarrierStats.html?airport=${document.getElementById('airport').value}&timeframe=${document.getElementById('timeframe').value}`
  }

    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split('=');
            if (decodeURIComponent(pair[0]) == variable) {
                return decodeURIComponent(pair[1]);
            }
        }
        console.log('Query variable %s not found', variable);
    }

    var selectedAirport = getQueryVariable('airport');
    var selectedTimeframe = getQueryVariable('timeframe');
//    debugger;

    // Set defaults if no airport or timeframe is selected
    // (i.e. first time the page is open)
    if (!selectedAirport) {selectedAirport = 'ATL';}
    if (!selectedTimeframe) {selectedTimeframe = 'annual';}

    console.log("Selected airport is: " + selectedAirport);

    document.getElementById(selectedAirport).selected=true;
    document.getElementById(selectedTimeframe).selected=true;


    var svg = dimple.newSvg("#chartContainer", 590, 400);
    var filename = `data/airport_carrier_stats_${selectedTimeframe}.csv`
//    debugger;
    d3.csv(filename, function (data) {
      data2 = data.filter(function(row) {
        return row['Origin'] === selectedAirport;
      })
      console.log("Data rows = " + data.length);
      console.log("Filtered rows = " + data2.length);
      // console.log("Airport argument is: " + get('airport'));
//      console.log(window.location.search);
//      debugger;
      var myChart = new dimple.chart(svg, data2);
      myChart.setBounds(60, 45, 510, 315);
      myChart.addCategoryAxis("x", "CarrierName");
      myChart.addMeasureAxis("y", "Count");
      var series = myChart.addSeries(["RecordType"], dimple.plot.bar);
      myChart.addLegend(200, 10, 380, 20, "right");
      series.getTooltipText = function(e) {
        var key = e.key;
        console.log("KEY = " + key);
        var fields = key.split("_");
        var recordType = fields[0];
        var carrier = fields[1];
        var returnValue = "";

        if (recordType === "Totals") {
          returnValue = [`On-Time Flights = ${e.yValue}`];
        } else {
          var filtered = data2.filter(function(row) {
            return row['RecordType'] === 'Delays' && row['CarrierName'] === carrier;
          })
          var ontimeFilter = data2.filter(function(row) {
            return row['RecordType'] === 'Totals' && row['CarrierName'] === carrier;
          })
          var ontimeFlights = ontimeFilter.reduce(function(a, b) {
            return a + parseFloat(b['Count']);
          }, 0);
          var delayedFlights = e.yValue;
          console.log(`Delayed flights = ${delayedFlights}`)
          console.log(`On-Time flights = ${ontimeFlights}`)
          var totalFlights = ontimeFlights + delayedFlights;
          var delayedPercent = delayedFlights / totalFlights; 
          // debugger;
          var delayedMins = filtered.reduce(function(a, b) {
            return a + parseFloat(b['ArrDelayMins']);
          }, 0);
          var carrierDelayMins = filtered.reduce(function(a, b) {
            return a + parseFloat(b['CarrierDelayMins']);
          }, 0);
          var weatherDelayMins = filtered.reduce(function(a, b) {
            return a + parseFloat(b['WeatherDelayMins']);
          }, 0);
          var nasDelayMins = filtered.reduce(function(a, b) {
            return a + parseFloat(b['NasDelayMins']);
          }, 0);
          var securityDelayMins = filtered.reduce(function(a, b) {
            return a + parseFloat(b['SecurityDelayMins']);
          }, 0);
          var lateAircraftDelayMins = filtered.reduce(function(a, b) {
            return a + parseFloat(b['LateAircraftDelayMins']);
          }, 0);
          // debugger;
          returnValue = [`Delayed Flights = ${e.yValue} (${delayedPercent.toFixed(2) * 100}%)`,
            `Carrier Delay = ${(carrierDelayMins / delayedMins * 100).toFixed(2)}%`,
            `Weather Delay = ${Math.round(weatherDelayMins / delayedMins * 100, 2)}%`,
            `NAS Delay = ${Math.round(nasDelayMins / delayedMins * 100, 2)}%`,
            `Security Delay = ${Math.round(securityDelayMins / delayedMins * 100, 2)}%`,
            `Late Aircraft Delay = ${Math.round(lateAircraftDelayMins / delayedMins * 100, 2)}%`
            ];
        }
        // debugger;
        // console.log("Hello World");
        // console.log(filtered[0]);
        // console.log(filtered[0]['CarrierDelayMins'])
        return returnValue;
      };
      myChart.draw();
    });
  </script>
</div>
<div>
<p>
<p>Carrier On-Time Performance for America's Top 10 Airports

Based on domestic departures
US Department of Transportation - Bureau of Transportation Statistics</p>


Some observations:

  Flight delays are not consistent across carriers (even at the same airport). Some carriers are 'worse' than others.
  Flight delays are not dependent on weather. Summer months and Winter months share similar delay statistics.
</p>
</div>
</body>

</html>